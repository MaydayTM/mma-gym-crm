---
phase: 08-functionality-audit-e2e-testing
plan: 01
type: execute
depends_on: []
files_modified: [playwright.config.ts, package.json, e2e/helpers/auth.ts, e2e/helpers/supabase.ts, e2e/auth.spec.ts, e2e/claim-account.spec.ts]
---

<objective>
Set up Playwright test framework and write E2E tests for all authentication flows.

Purpose: Establish the test infrastructure that all subsequent plans depend on, and validate the most critical user flows (login, logout, password reset, account claiming).
Output: Working Playwright setup with auth helper utilities and passing auth E2E tests.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context:
@.planning/phases/04-roles-permissions-audit/04-01-SUMMARY.md
@.planning/phases/06-email-account-claim-testing/06-03-SUMMARY.md

# Key source files:
@src/App.tsx
@src/pages/Login.tsx
@src/pages/ForgotPassword.tsx
@src/pages/ResetPassword.tsx
@src/pages/ClaimAccount.tsx
@src/pages/ActivateAccount.tsx
@src/hooks/useAuth.ts

**Tech stack:** Vite + React 18 + TypeScript + Supabase Auth
**Established patterns:** Permission-based route guards, inline access denied UX
**Constraining decisions:**
- Phase 4: RoleGuard wraps page elements inside ProtectedRoute for layered auth
- Phase 6: Frontend handles all error_reason codes with Dutch messages for claim flow
- No test framework exists yet — this plan sets it up from scratch
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install and configure Playwright with test utilities</name>
  <files>playwright.config.ts, package.json, e2e/helpers/auth.ts, e2e/helpers/supabase.ts</files>
  <action>
1. Install Playwright: `npm install -D @playwright/test` then `npx playwright install chromium` (chromium only — skip firefox/webkit to keep CI fast).
2. Create `playwright.config.ts`:
   - baseURL: `http://localhost:5173`
   - webServer: command `npm run dev`, port 5173, reuseExistingServer true
   - testDir: `e2e/`
   - timeout: 30000, retries: 0
   - Use only chromium project
3. Add scripts to package.json: `"test:e2e": "npx playwright test"`, `"test:e2e:ui": "npx playwright test --ui"`
4. Create `e2e/helpers/auth.ts`:
   - `login(page, email, password)` — fills login form, clicks submit, waits for dashboard navigation
   - `logout(page)` — clicks user menu, clicks logout, waits for login page
   - `expectRedirectToLogin(page)` — asserts current URL is /login
5. Create `e2e/helpers/supabase.ts`:
   - Creates a Supabase admin client using env vars (SUPABASE_URL + SERVICE_ROLE_KEY from .env)
   - `getTestUser()` — returns known test credentials (use existing admin user — read from .env.test or hardcode test email)
   - NOTE: Do NOT create test users via API. Use existing admin account credentials. Create a `.env.test` file with TEST_USER_EMAIL and TEST_USER_PASSWORD that Mehdi fills in.
  </action>
  <verify>`npx playwright test --list` shows discovered test files without errors. Config loads correctly.</verify>
  <done>Playwright installed, config created, helper utilities exist, test discovery works.</done>
</task>

<task type="auto">
  <name>Task 2: Write E2E tests for core auth flows</name>
  <files>e2e/auth.spec.ts</files>
  <action>
Write `e2e/auth.spec.ts` with these test cases:

1. **"should redirect unauthenticated user to login"** — navigate to `/`, expect redirect to `/login`
2. **"should show login page with email and password fields"** — check form elements present
3. **"should show error for invalid credentials"** — fill wrong password, submit, expect error message visible
4. **"should login successfully with valid credentials"** — use auth helper to login, expect dashboard visible (check for a known dashboard element like KPI cards or "Dashboard" heading)
5. **"should logout and redirect to login"** — login first, then use logout helper, expect login page
6. **"should show forgot password page"** — navigate to /forgot-password, check form exists
7. **"should navigate between login and forgot-password"** — click "Wachtwoord vergeten?" link on login, verify navigation

Use `test.describe('Authentication')` grouping. Use `test.beforeEach` to navigate to login page. Use `.env.test` for credentials via `dotenv` or Playwright's built-in env handling.

Do NOT test actual password reset email delivery (requires Resend). Just verify the UI flow and form validation.
  </action>
  <verify>`npx playwright test e2e/auth.spec.ts` — at minimum the page-level tests pass (login page renders, navigation works). Login test passes if .env.test credentials are set.</verify>
  <done>Auth spec file has 7+ test cases. Tests that don't require real credentials verify UI elements. Tests with credentials pass when .env.test is configured.</done>
</task>

<task type="auto">
  <name>Task 3: Write E2E tests for claim account and activation flows</name>
  <files>e2e/claim-account.spec.ts</files>
  <action>
Write `e2e/claim-account.spec.ts` with these test cases:

1. **"should show claim account page with search form"** — navigate to /claim-account, check email/phone input and submit button exist
2. **"should show error for non-existent member"** — fill random email, submit, expect error message (no account enumeration — should show generic message)
3. **"should navigate from login to claim account"** — click claim account link on login page
4. **"should show activate account page"** — navigate to /activate, check it handles missing/invalid token gracefully (shows error, not crash)
5. **"should show activate page with token parameter"** — navigate to /activate?token=invalid-token, expect error message about invalid/expired token

These tests verify UI rendering and error handling without needing actual claim tokens. The real claim flow was already code-audited in Phase 6.

NOTE: Do NOT attempt to test real claim email sending. That requires Resend and is an integration test beyond scope.
  </action>
  <verify>`npx playwright test e2e/claim-account.spec.ts` — all UI-level tests pass.</verify>
  <done>Claim account spec has 5+ test cases covering UI rendering, error states, and navigation. No real email sending required.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx playwright test` runs without configuration errors
- [ ] Auth tests pass (UI tests always, credential tests when .env.test set)
- [ ] Claim account tests pass
- [ ] No TypeScript errors in test files
- [ ] `.env.test` documented in README or as `.env.test.example`
</verification>

<success_criteria>

- Playwright installed and configured for Vite dev server
- Test helpers for auth login/logout created
- 12+ E2E test cases across 2 spec files
- All UI-level tests pass
- Foundation ready for subsequent test plans
</success_criteria>

<output>
After completion, create `.planning/phases/08-functionality-audit-e2e-testing/08-01-SUMMARY.md`
</output>
