---
phase: 08-functionality-audit-e2e-testing
plan: 02
type: execute
depends_on: ["08-01"]
files_modified: [e2e/members.spec.ts, e2e/member-detail.spec.ts, e2e/leads.spec.ts]
---

<objective>
Write E2E tests for Member management (list, CRUD, detail) and Lead pipeline (kanban, create, convert).

Purpose: Validate the two most-used CRM modules work correctly end-to-end with real browser interactions.
Output: Passing E2E test suites for Members and Leads modules.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-functionality-audit-e2e-testing/08-01-SUMMARY.md

# Key source files:
@src/pages/Members.tsx
@src/pages/MemberDetail.tsx
@src/pages/Leads.tsx
@src/components/leads/LeadDetailModal.tsx
@src/hooks/useMembers.ts
@src/hooks/useLeads.ts

**Established patterns:**
- Permission-based route guards (canEditMembers, canManageLeads)
- Action buttons hidden for non-privileged users
- Own-profile edit uses member.id === currentMember?.id

**Constraining decisions:**
- Phase 4: Hide action buttons (not disabled) for non-privileged users
- All tests should login as admin to have full access
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write E2E tests for Members page</name>
  <files>e2e/members.spec.ts</files>
  <action>
Write `e2e/members.spec.ts` with `test.describe('Members')`:

Setup: `test.beforeEach` — login as admin, navigate to /members.

Test cases:
1. **"should display members table"** — expect table with member rows visible (at least 1 row if data exists)
2. **"should search members by name"** — type in search input, expect table to filter (fewer rows or specific member visible)
3. **"should filter members by status"** — click status filter dropdown, select "active", verify results
4. **"should open add member modal"** — click "Nieuw lid" or add button, expect modal with form fields (first_name, last_name, email)
5. **"should create a new member"** — fill form with test data (use timestamp in email for uniqueness like `test-{Date.now()}@test.com`), submit, expect success (toast or redirect). After test, clean up via Supabase admin client if possible.
6. **"should navigate to member detail"** — click on a member row, expect navigation to /members/:id

Use page.waitForLoadState('networkidle') or waitForSelector to handle async data loading. Be defensive with selectors — use data-testid attributes if needed, but prefer text content or role-based selectors first.
  </action>
  <verify>`npx playwright test e2e/members.spec.ts` — tests pass when logged in as admin with existing member data.</verify>
  <done>Members spec has 6+ test cases covering table display, search, filter, create, and navigation.</done>
</task>

<task type="auto">
  <name>Task 2: Write E2E tests for MemberDetail page</name>
  <files>e2e/member-detail.spec.ts</files>
  <action>
Write `e2e/member-detail.spec.ts` with `test.describe('Member Detail')`:

Setup: `test.beforeEach` — login as admin, navigate to /members, click first member to go to detail page.

Test cases:
1. **"should display member profile info"** — expect name, email, status, role visible on page
2. **"should show subscription tab"** — click subscriptions tab, expect subscription list or empty state
3. **"should show check-in history tab"** — click check-ins tab, expect history or empty state
4. **"should show belt tracking"** — expect belt progress card visible (may be empty for some members)
5. **"should open edit member form"** — click edit button, expect form pre-filled with member data
6. **"should edit member details"** — change a non-critical field (e.g., phone number), save, expect updated value visible
7. **"should show door access card"** — expect DoorAccessCard component present on the page

NOTE: Do NOT test member deletion in this spec — too destructive for shared test data. Skip delete test or mark as test.skip with comment.
  </action>
  <verify>`npx playwright test e2e/member-detail.spec.ts` — tests pass against existing member data.</verify>
  <done>MemberDetail spec has 7+ test cases covering profile display, tabs, edit, and component presence.</done>
</task>

<task type="auto">
  <name>Task 3: Write E2E tests for Leads pipeline</name>
  <files>e2e/leads.spec.ts</files>
  <action>
Write `e2e/leads.spec.ts` with `test.describe('Leads Pipeline')`:

Setup: `test.beforeEach` — login as admin, navigate to /leads.

Test cases:
1. **"should display kanban board with status columns"** — expect columns: Nieuw, Gecontacteerd, Proefles Gepland, Proefles Gedaan, Geconverteerd, Verloren
2. **"should open new lead form"** — click add lead button, expect modal/form with fields
3. **"should create a new lead"** — fill first_name, last_name, email (use timestamp for uniqueness), select source, submit. Expect lead card appears in "Nieuw" column.
4. **"should open lead detail modal"** — click on a lead card, expect detail modal with contact info, notes, status
5. **"should update lead status"** — in lead detail, change status dropdown, save, expect lead moves to new column (or verify via page reload)
6. **"should filter leads by source"** — if source filter exists, test it

After tests, clean up test leads via Supabase admin client if feasible. Use unique identifiers (timestamp in name) to find and delete test data.
  </action>
  <verify>`npx playwright test e2e/leads.spec.ts` — tests pass with admin login.</verify>
  <done>Leads spec has 6+ test cases covering kanban display, CRUD, and status transitions.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx playwright test e2e/members.spec.ts` passes
- [ ] `npx playwright test e2e/member-detail.spec.ts` passes
- [ ] `npx playwright test e2e/leads.spec.ts` passes
- [ ] No flaky tests (run twice to check)
- [ ] Test cleanup doesn't leave stale test data
</verification>

<success_criteria>

- All 3 spec files written and passing
- 19+ E2E test cases for Members and Leads modules
- Tests cover CRUD, navigation, search/filter, and status transitions
- Test data cleanup strategy in place
</success_criteria>

<output>
After completion, create `.planning/phases/08-functionality-audit-e2e-testing/08-02-SUMMARY.md`
</output>
