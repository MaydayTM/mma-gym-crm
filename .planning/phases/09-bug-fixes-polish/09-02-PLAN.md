---
phase: 09-bug-fixes-polish
plan: 02
type: execute
depends_on: ["09-01"]
files_modified: [src/App.tsx, vite.config.ts]
---

<objective>
Code-split the application using React.lazy() route-based splitting to reduce the main bundle from 1.5MB to under 500KB initial load.

Purpose: 1.5MB main chunk causes slow initial page loads. Route-based code-splitting ensures users only download code for the page they're visiting.
Output: Main chunk under 500KB, lazy-loaded route chunks, build passes without chunk size warnings.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-bug-fixes-polish/09-01-SUMMARY.md

# Current build output:
# dist/assets/main-kD8KvCQW.js  1,587.55 kB │ gzip: 421.69 kB
# Vite warns: "Some chunks are larger than 500 kB after minification"
# Shop pages already code-split (ShopLanding, ShopProductDetail, ShopCheckout, ShopCart, ShopOrderComplete)

# Key source files:
@src/App.tsx
@vite.config.ts

**Established patterns:**
- React Router v6 with nested routes
- Shop pages already use lazy loading (visible in build output as separate chunks)
- Suspense fallback needed for lazy routes
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add React.lazy() route-based code splitting for all page components</name>
  <files>src/App.tsx</files>
  <action>
In `src/App.tsx`, convert all page component imports to React.lazy():

**Current pattern (static imports):**
```tsx
import Dashboard from './pages/Dashboard'
import Members from './pages/Members'
// etc.
```

**Target pattern (lazy imports):**
```tsx
const Dashboard = lazy(() => import('./pages/Dashboard'))
const Members = lazy(() => import('./pages/Members'))
const MemberDetail = lazy(() => import('./pages/MemberDetail'))
const Leads = lazy(() => import('./pages/Leads'))
const Subscriptions = lazy(() => import('./pages/Subscriptions'))
const SubscriptionsManage = lazy(() => import('./pages/SubscriptionsManage'))
const Schedule = lazy(() => import('./pages/Schedule'))
const Reservations = lazy(() => import('./pages/Reservations'))
const CheckIn = lazy(() => import('./pages/CheckIn'))
const Reports = lazy(() => import('./pages/Reports'))
const Team = lazy(() => import('./pages/Team'))
const Settings = lazy(() => import('./pages/Settings'))
const Email = lazy(() => import('./pages/Email'))
const GymScreen = lazy(() => import('./pages/GymScreen'))
const KitanaHub = lazy(() => import('./pages/KitanaHub'))
const DoorTest = lazy(() => import('./pages/DoorTest'))
// Login, ForgotPassword, ResetPassword, ClaimAccount, ActivateAccount
const Login = lazy(() => import('./pages/Login'))
const ForgotPassword = lazy(() => import('./pages/ForgotPassword'))
const ResetPassword = lazy(() => import('./pages/ResetPassword'))
const ClaimAccount = lazy(() => import('./pages/ClaimAccount'))
const ActivateAccount = lazy(() => import('./pages/ActivateAccount'))
// Checkout pages
const PlansOverview = lazy(() => import('./pages/checkout/PlansOverview'))
const PlanCheckout = lazy(() => import('./pages/checkout/PlanCheckout'))
const CheckoutSuccess = lazy(() => import('./pages/checkout/CheckoutSuccess'))
```

**Add Suspense wrapper:**
Wrap the `<Routes>` block with `<Suspense fallback={<LoadingFallback />}>`.

Create a simple `LoadingFallback` component inline in App.tsx:
```tsx
function LoadingFallback() {
  return (
    <div className="flex items-center justify-center min-h-screen">
      <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600" />
    </div>
  )
}
```

**Do NOT lazy-load:**
- Layout components (Sidebar, etc.) — they're always visible
- ErrorBoundary — must be available immediately
- AuthContext/providers — must be available before routes

**Ensure all page components use default exports.** If any use named exports, either:
- Add `export default` to the page component
- Use `lazy(() => import('./pages/Foo').then(m => ({ default: m.Foo })))` pattern
  </action>
  <verify>`npm run build` succeeds. Build output shows multiple route chunks instead of one monolithic main chunk. No chunk exceeds 500KB (or the warning is gone). `npm run dev` works — navigate to each page and verify lazy loading works (brief spinner then page appears).</verify>
  <done>Main chunk under 500KB. Route chunks lazy-loaded. No Vite chunk size warnings. All pages load correctly.</done>
</task>

<task type="auto">
  <name>Task 2: Verify build output and run E2E smoke test</name>
  <files>vite.config.ts</files>
  <action>
1. Run `npm run build` and capture output. Verify:
   - Main chunk is under 500KB
   - Multiple route chunks exist
   - No chunk size warnings from Vite

2. If main chunk is still over 500KB, add manual chunks in vite.config.ts:
```ts
build: {
  rollupOptions: {
    output: {
      manualChunks: {
        'react-vendor': ['react', 'react-dom', 'react-router-dom'],
        'query-vendor': ['@tanstack/react-query'],
        'supabase-vendor': ['@supabase/supabase-js'],
        'ui-vendor': ['lucide-react', 'recharts'],
      }
    }
  }
}
```

3. Run `npx tsc --noEmit` to verify no type errors.

4. Run `npx eslint src/ --max-warnings 0` to verify still clean from Plan 09-01.

5. Start dev server briefly (`npm run dev`) and verify the app loads without errors.
  </action>
  <verify>`npm run build` output shows no chunks over 500KB. `npx tsc --noEmit` passes. `npx eslint src/ --max-warnings 0` passes.</verify>
  <done>Build optimized: no chunk over 500KB, all checks pass, app loads correctly with lazy routes.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` — no chunk size warnings
- [ ] Main JS chunk under 500KB
- [ ] `npx tsc --noEmit` — passes
- [ ] `npx eslint src/ --max-warnings 0` — passes
- [ ] App loads and navigates correctly with lazy routes
</verification>

<success_criteria>

- Main bundle reduced from 1.5MB to under 500KB
- Route-based code splitting with React.lazy()
- Suspense fallback shows loading spinner during chunk download
- No TypeScript or ESLint errors
- Build passes cleanly
- Phase 9 complete
</success_criteria>

<output>
After completion, create `.planning/phases/09-bug-fixes-polish/09-02-SUMMARY.md`
</output>
