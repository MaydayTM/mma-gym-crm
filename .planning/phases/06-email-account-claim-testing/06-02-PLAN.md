---
phase: 06-email-account-claim-testing
plan: 02
type: execute
depends_on: ["06-01"]
files_modified:
  - supabase/functions/send-claim-email/index.ts
  - supabase/functions/complete-claim/index.ts
  - supabase/functions/verify-claim-token/index.ts
domain: supabase-edge-functions
---

<objective>
Audit and harden the claim account Edge Functions for security, correctness, and edge case handling.

Purpose: The claim flow has 4 Edge Functions that form the critical account activation path. Before beta, each must be audited for security issues, error handling gaps, and scalability problems. This plan covers send-claim-email, verify-claim-token, and complete-claim.
Output: Hardened Edge Functions with security fixes deployed to production.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Key files:
@supabase/functions/send-claim-email/index.ts
@supabase/functions/verify-claim-token/index.ts
@supabase/functions/complete-claim/index.ts

# Prior plan context:
@.planning/phases/06-email-account-claim-testing/06-01-SUMMARY.md

**Constraining decisions:**
- Edge Functions pinned to supabase-js v2.39.3
- Account claim tokens stored as SHA256 hash, 48h expiry
- SERVICE_ROLE_KEY for edge functions
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit and fix send-claim-email security</name>
  <files>supabase/functions/send-claim-email/index.ts</files>
  <action>
Audit send-claim-email for security and correctness issues:

**Issue 1 - Role check queries by user.id not auth_user_id:**
Line 288-289: `supabase.from('members').select('role').eq('id', user.id)` - This queries members.id with the auth user UUID. But members.id is the member UUID, and user.id is the Supabase Auth UUID. These are different! The query should use `.eq('auth_user_id', user.id)` to find the member record linked to the authenticated user. Verify this by checking the members table schema - if `id` is the member PK and `auth_user_id` is the auth link, this is a bug.

**Issue 2 - Missing input validation:**
The `member_id` from the request body is used directly without UUID format validation. Add basic UUID regex check before querying the database.

**Issue 3 - Email template duplication:**
The entire HTML email template is duplicated between send-claim-email and request-claim-email. This is a maintenance risk but NOT a security issue. Document it for future cleanup but do NOT refactor now (audit phase, not refactor phase).

Fix issues 1 and 2. For issue 3, add a code comment noting the duplication.

Deploy: `npx supabase functions deploy send-claim-email`
  </action>
  <verify>
1. Grep for `.eq('id', user.id)` in send-claim-email - should NOT exist (should be auth_user_id)
2. Search for UUID validation in the function
3. Function deploys without errors
  </verify>
  <done>
- Role check correctly uses auth_user_id to find member
- member_id input validated as UUID format before DB query
- Email template duplication documented with comment
- Function deployed to production
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix complete-claim scalability and security issues</name>
  <files>supabase/functions/complete-claim/index.ts</files>
  <action>
Audit complete-claim for security and scalability:

**Issue 1 - listUsers() fetches ALL auth users (critical):**
Line 113: `supabaseAdmin.auth.admin.listUsers()` loads the entire user table into memory to check if email exists. This doesn't scale and is slow. Replace with a targeted lookup:
```typescript
const { data: existingUsers } = await supabaseAdmin.auth.admin.listUsers({
  filter: { email: memberEmail },
  page: 1,
  perPage: 1,
})
```
However, Supabase Admin API's listUsers doesn't support email filter natively. Instead, use the recommended approach:
- Try to create the user first (step 3)
- If it fails with "User already registered", handle that case
- This is more atomic and avoids the list entirely

Alternatively, use `supabaseAdmin.rpc()` to query auth.users directly if a DB function exists, or query with the admin API's `getUserByEmail` if available in the SDK version.

Check the supabase-js v2.39.3 admin API docs - if `getUserById` or lookup by email is available, use that. If not, the simplest fix is to attempt user creation and handle the duplicate error gracefully.

**Issue 2 - verify_claim_token called but error_reason not checked:**
Lines 86-106: The function calls verify_claim_token but only checks if result is empty. The improved verify_claim_token (migration 061) returns `error_reason` field. Check for specific error reasons (TOKEN_EXPIRED, TOKEN_ALREADY_CLAIMED, etc.) and return user-friendly Dutch error messages, similar to how verify-claim-token Edge Function handles it.

**Issue 3 - Password logged or leaked:**
Verify that the password is NEVER logged in any console.log/console.error statement. Currently looks clean but confirm.

Fix issues 1 and 2. Verify issue 3.

Deploy: `npx supabase functions deploy complete-claim --no-verify-jwt`
  </action>
  <verify>
1. Grep for `listUsers()` without filter - should NOT exist
2. Grep for `error_reason` - should be checked and handled
3. Grep for `password` in console.log/console.error statements - should return 0
4. Function deploys without errors
  </verify>
  <done>
- listUsers() replaced with targeted lookup or try-create pattern
- error_reason from verify_claim_token is checked with user-friendly Dutch messages
- No password leaks in logs
- Function deployed to production
  </done>
</task>

<task type="auto">
  <name>Task 3: Deploy all claim functions and E2E smoke test</name>
  <files>supabase/functions/verify-claim-token/index.ts</files>
  <action>
Quick audit of verify-claim-token (this function looks solid from code review but verify):
1. Confirm it handles all error_reason values from migration 061
2. Confirm it never returns member data on invalid tokens
3. Confirm CORS headers are consistent

Then deploy all modified functions and run smoke tests:

1. Deploy verify-claim-token: `npx supabase functions deploy verify-claim-token --no-verify-jwt`
2. Smoke test verify-claim-token with invalid token:
   `curl -X POST https://wiuzjpoizxeycrshsuqn.supabase.co/functions/v1/verify-claim-token -H "Content-Type: application/json" -d '{"token":"invalid-token-123"}'`
   Expected: `{"valid":false,"error":"...ongeldig..."}` with NO member data

3. Smoke test complete-claim with invalid token:
   `curl -X POST https://wiuzjpoizxeycrshsuqn.supabase.co/functions/v1/complete-claim -H "Content-Type: application/json" -d '{"token":"invalid","password":"test1234"}'`
   Expected: Error response, no account created

4. Verify all 4 claim-related functions are deployed: `npx supabase functions list`
  </action>
  <verify>
1. All 4 functions appear in `npx supabase functions list`
2. Invalid token returns error without member data
3. Invalid complete-claim returns error without creating account
4. No console errors in function logs
  </verify>
  <done>
- verify-claim-token audited and confirmed correct
- All 4 claim functions deployed to production
- Smoke tests pass for invalid token scenarios
- No information leaks on error paths
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] send-claim-email role check uses auth_user_id
- [ ] complete-claim doesn't fetch all users
- [ ] complete-claim checks error_reason from verify_claim_token
- [ ] All functions deployed
- [ ] Smoke tests pass (invalid tokens rejected, no data leaks)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No security regressions
- Edge Functions handle edge cases with user-friendly Dutch error messages
- Scalability issue (listUsers) resolved
</success_criteria>

<output>
After completion, create `.planning/phases/06-email-account-claim-testing/06-02-SUMMARY.md`
</output>
