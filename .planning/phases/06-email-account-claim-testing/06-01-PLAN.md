---
phase: 06-email-account-claim-testing
plan: 01
type: execute
depends_on: []
files_modified:
  - supabase/functions/email-webhook/index.ts
  - supabase/functions/request-claim-email/index.ts
domain: supabase-edge-functions
---

<objective>
Harden email webhook security and clean up debug leaks in claim email functions.

Purpose: The email-webhook Edge Function accepts all incoming webhooks without signature verification (TODO in code). The request-claim-email function leaks debug info in responses. Both are security issues that must be fixed before beta.
Output: Secure webhook verification via Resend svix signatures, debug info removed from production responses.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Key files:
@supabase/functions/email-webhook/index.ts
@supabase/functions/request-claim-email/index.ts

# Prior phase context:
@.planning/phases/05-subscriptions-billing-audit/05-02-SUMMARY.md

**Constraining decisions:**
- Edge Functions pinned to supabase-js v2.39.3
- SERVICE_ROLE_KEY pattern for edge functions (not ANON_KEY)
- Resend configured with noreply@reconnect.academy
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Resend svix webhook signature verification</name>
  <files>supabase/functions/email-webhook/index.ts</files>
  <action>
Implement webhook signature verification in email-webhook/index.ts using the svix headers that Resend sends. The function already reads `RESEND_WEBHOOK_SECRET` from env and allows svix headers in CORS.

Implementation approach:
1. Import `Webhook` from `https://esm.sh/svix@1.15.0` (Deno-compatible ESM import)
2. After parsing the raw body, verify the signature using the svix library:
   - Get headers: `svix-id`, `svix-timestamp`, `svix-signature` from request
   - Create `new Webhook(webhookSecret)` and call `wh.verify(body, headers)`
   - If verification fails, return 401 (NOT 200 - we want Resend to know it failed)
3. If `RESEND_WEBHOOK_SECRET` is not set, log a warning but still accept webhooks (graceful degradation for dev environments)
4. Parse the verified body as JSON instead of re-reading from request

Important: Read the raw body as text FIRST (for signature verification), then JSON.parse it. Do NOT call req.json() as that consumes the stream.

Reference: https://resend.com/docs/dashboard/webhooks/verify-webhooks
  </action>
  <verify>
1. Check that the function compiles: `cd supabase/functions/email-webhook && deno check index.ts` (or review import syntax)
2. Code review: verify signature check happens BEFORE any database operations
3. Verify 401 is returned on invalid signature, 200 on valid
  </verify>
  <done>
- Webhook signature verification implemented using svix library
- Invalid signatures return 401
- Missing RESEND_WEBHOOK_SECRET gracefully degrades with warning log
- Raw body read as text first, then parsed as JSON after verification
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove debug info leaks from request-claim-email responses</name>
  <files>supabase/functions/request-claim-email/index.ts</files>
  <action>
The request-claim-email function currently returns `debug` objects in every response (including error paths). This leaks internal state (step names, error messages, identifiers) to the public. This is a public endpoint with no auth.

Fix:
1. Remove ALL `debug` properties from every Response JSON body (there are ~7 occurrences)
2. Remove verbose `console.log` statements that log member emails, request bodies, and Resend API key lengths - these are fine for development but not production. Keep only error-level logging: `console.error` for actual failures
3. Keep the generic success message pattern (GENERIC_SUCCESS_MESSAGE) - this is correct security behavior
4. The `hint` field on the "member can't claim" response (line ~216) reveals the reason to the client - remove it. The generic message is sufficient.

Do NOT change the email sending logic, token creation, or any functional behavior. Only remove information disclosure.
  </action>
  <verify>
1. Grep the file for `debug` - should return 0 matches
2. Grep for `console.log` - should be minimal (removed verbose logs)
3. Grep for `hint` in response bodies - should return 0 matches
4. Verify all responses still return proper `success` and `message` fields
  </verify>
  <done>
- No `debug` properties in any response body
- No `hint` field leaking claim failure reasons
- Verbose console.log statements removed (only console.error for failures remains)
- All responses maintain correct success/message structure
- Generic success message still used for all member-lookup outcomes (enumeration prevention intact)
  </done>
</task>

<task type="auto">
  <name>Task 3: Deploy hardened functions and verify</name>
  <files>supabase/functions/email-webhook/index.ts, supabase/functions/request-claim-email/index.ts</files>
  <action>
Deploy both updated Edge Functions to production:

1. Deploy email-webhook: `npx supabase functions deploy email-webhook --no-verify-jwt`
2. Deploy request-claim-email: `npx supabase functions deploy request-claim-email --no-verify-jwt`
3. Verify RESEND_WEBHOOK_SECRET is set in Supabase secrets: `npx supabase secrets list` - if not present, note it as a required manual step (the webhook function gracefully degrades)
4. Run a quick smoke test: `curl -X POST https://wiuzjpoizxeycrshsuqn.supabase.co/functions/v1/request-claim-email -H "Content-Type: application/json" -d '{"identifier":"nonexistent@test.com"}'` - should return generic success with NO debug info
  </action>
  <verify>
1. Both functions deploy without errors
2. Smoke test returns `{"success":true,"message":"Als er een account..."}` with NO debug field
3. email-webhook function is deployed (check via `npx supabase functions list`)
  </verify>
  <done>
- Both Edge Functions deployed to production
- request-claim-email returns no debug info
- email-webhook has signature verification ready (activates when RESEND_WEBHOOK_SECRET is set)
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] email-webhook has svix signature verification code
- [ ] request-claim-email has zero debug/hint leaks
- [ ] Both functions deployed to production
- [ ] Smoke test confirms no info disclosure
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No security regressions introduced
- Webhook verification is in place (or gracefully degrades)
- No debug information leaks in public endpoint responses
</success_criteria>

<output>
After completion, create `.planning/phases/06-email-account-claim-testing/06-01-SUMMARY.md`
</output>
