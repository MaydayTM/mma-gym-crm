---
phase: 06-email-account-claim-testing
plan: 03
type: execute
depends_on: ["06-02"]
files_modified:
  - src/components/settings/OnboardingSettings.tsx
  - src/pages/ClaimAccount.tsx
  - src/pages/ActivateAccount.tsx
domain: react-frontend
---

<objective>
Audit frontend claim flow pages and bulk invitation admin for correctness, then run full E2E verification of the complete claim account pipeline.

Purpose: Frontend pages must correctly handle all Edge Function responses (including new error_reason codes from Plan 02). The OnboardingSettings bulk invitation flow needs verification. Finally, a human must verify the full flow works end-to-end with a real email.
Output: Audited frontend pages deployed, full E2E claim flow verified by human tester.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Key files:
@src/pages/ClaimAccount.tsx
@src/pages/ActivateAccount.tsx
@src/components/settings/OnboardingSettings.tsx
@src/hooks/useClaimAccount.ts

# Prior plan context:
@.planning/phases/06-email-account-claim-testing/06-01-SUMMARY.md
@.planning/phases/06-email-account-claim-testing/06-02-SUMMARY.md

**Constraining decisions:**
- Action buttons hidden (not disabled) for non-privileged users
- Inline access denied messages instead of redirect
- Settings sections split: admin-only (Onboarding accessible by admin/medewerker)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit frontend claim pages for error handling completeness</name>
  <files>src/pages/ClaimAccount.tsx, src/pages/ActivateAccount.tsx</files>
  <action>
Audit both public claim pages for completeness:

**ClaimAccount.tsx:**
1. Verify it calls request-claim-email Edge Function correctly
2. Verify it shows the generic success message regardless of outcome (enumeration prevention)
3. Check that the `hint` field (if returned by old function version) is NOT displayed to the user. Since Plan 01 removed hints from the Edge Function, the frontend should not depend on it. If it reads `hint`, remove that logic.
4. Verify loading states and error handling are clean
5. Verify the link to /activate or /login is correct

**ActivateAccount.tsx:**
1. Verify it handles ALL error_reason codes from verify-claim-token:
   - TOKEN_NOT_FOUND
   - TOKEN_EXPIRED
   - TOKEN_ALREADY_CLAIMED
   - MEMBER_NOT_FOUND
   - MEMBER_ALREADY_ACTIVATED
2. Verify password validation matches Edge Function requirements (min 8 chars)
3. Verify the complete-claim call handles new error responses from Plan 02 fixes
4. Verify auto-login after successful claim works (session set correctly)
5. Verify the redirect after activation goes to `/` (dashboard)

Fix any issues found. Build to verify no TypeScript errors: `npm run build`
  </action>
  <verify>
1. `npm run build` passes without errors
2. ClaimAccount shows generic message on all outcomes
3. ActivateAccount handles all 5 error_reason codes
4. No stale references to removed `hint` or `debug` fields
  </verify>
  <done>
- ClaimAccount page handles all response shapes correctly
- ActivateAccount page handles all error_reason codes with Dutch messages
- Password validation consistent between frontend and Edge Function
- Auto-login flow correctly implemented
- Build passes
  </done>
</task>

<task type="auto">
  <name>Task 2: Audit OnboardingSettings bulk invitation flow</name>
  <files>src/components/settings/OnboardingSettings.tsx, src/hooks/useClaimAccount.ts</files>
  <action>
Audit the admin bulk invitation flow:

**OnboardingSettings.tsx:**
1. Verify stats cards query correctly (useClaimAccountStats hook)
2. Verify member list filtering works (all / no_invite / pending)
3. Verify single invitation send works (calls send-claim-email)
4. Verify bulk send works (useSendBulkClaimEmails - Promise.allSettled pattern)
5. Check that "Resend" button appears for members with pending tokens
6. Verify members without email are disabled/hidden (can't send invite)
7. Verify permission check - only admin/medewerker can access

**useClaimAccount.ts:**
1. Verify claim_account_stats RPC call matches database view schema
2. Verify useSendBulkClaimEmails handles partial failures (some succeed, some fail)
3. Check query invalidation after sending invitations (stats should refresh)

Fix any issues found. Build to verify: `npm run build`
  </action>
  <verify>
1. `npm run build` passes
2. OnboardingSettings renders stats correctly
3. Bulk send handles mixed success/failure
4. Permission checks in place
  </verify>
  <done>
- OnboardingSettings correctly displays stats and member lists
- Bulk invitation handles partial failures with clear feedback
- Query invalidation refreshes stats after sends
- Permission checks verified (admin/medewerker only)
- Build passes
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete claim account flow audited and hardened across Plans 01, 02, and 03:
- Webhook signature verification added
- Debug info leaks removed
- Edge Function security fixes deployed
- Frontend error handling updated
- OnboardingSettings bulk flow audited
  </what-built>
  <how-to-verify>
    1. Open: https://crm.mmagym.be/settings → Onboarding tab
    2. Check that stats cards load (unclaimed, pending, activated counts)
    3. Select a test member from the list (must have email, no auth account)
    4. Click "Verstuur Uitnodiging" to send a claim email
    5. Check your email inbox (or the test member's inbox) for the activation email
    6. Verify the email renders correctly (logo, button, text in Dutch)
    7. Click "Account Activeren" button in the email
    8. Verify you arrive at https://crm.mmagym.be/activate?token=...
    9. Verify member preview shows (name, email, member number)
    10. Set a password (min 8 characters) and submit
    11. Verify auto-login works (redirected to dashboard)
    12. Log out and verify login with the new credentials works
    13. Test edge case: Visit https://crm.mmagym.be/claim-account
    14. Enter a non-existent email → should show generic message (no error detail)
    15. Check Resend dashboard for delivery status of sent emails
  </how-to-verify>
  <resume-signal>Type "approved" to complete Phase 6, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build` succeeds
- [ ] Frontend handles all error_reason codes
- [ ] OnboardingSettings stats and bulk send work
- [ ] Full E2E flow verified by human (send → email → activate → login)
- [ ] No information leaks on public pages
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Human has verified full E2E claim flow works
- Email delivery confirmed via Resend
- No security regressions
- Phase 6 complete
</success_criteria>

<output>
After completion, create `.planning/phases/06-email-account-claim-testing/06-03-SUMMARY.md`
</output>
