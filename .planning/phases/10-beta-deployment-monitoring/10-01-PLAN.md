---
phase: 10-beta-deployment-monitoring
plan: 01
type: execute
depends_on: []
files_modified: [src/instrument.ts, src/main.tsx, src/lib/supabase.ts, src/App.tsx, vite.config.ts, vercel.json, package.json]
---

<objective>
Install and configure Sentry error tracking with source maps, and harden the application for production use by removing debug logging and adding security headers.

Purpose: Ensure all runtime errors are captured and reported before beta testers start using the app, and eliminate information leakage from debug logs.
Output: Working Sentry integration with error boundary, source map uploads, and cleaned-up production build.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context:
@.planning/phases/09-bug-fixes-polish/09-02-SUMMARY.md

# Key files:
@src/main.tsx
@src/App.tsx
@src/lib/supabase.ts
@vite.config.ts
@vercel.json

**Tech stack available:** Vite + React 18 + TypeScript, Vercel hosting, Supabase backend
**Established patterns:** React.lazy() code splitting (Phase 9), vendor chunking in vite.config.ts

**Constraining decisions:**
- Phase 9: Route-based code splitting with React.lazy() already in App.tsx — Sentry error boundary must wrap the Suspense boundary
- Vercel hosting: security headers configured in vercel.json

**Issues being addressed:** None from ISSUES.md (all are hardware-related)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install and configure Sentry with source maps</name>
  <files>package.json, src/instrument.ts, src/main.tsx, vite.config.ts</files>
  <action>
1. Install packages:
   ```
   npm install @sentry/react
   npm install -D @sentry/vite-plugin
   ```

2. Create `src/instrument.ts`:
   ```ts
   import * as Sentry from '@sentry/react';

   Sentry.init({
     dsn: import.meta.env.VITE_SENTRY_DSN,
     integrations: [
       Sentry.browserTracingIntegration(),
       Sentry.replayIntegration(),
     ],
     // Performance: capture 20% of transactions (adjust for beta)
     tracesSampleRate: 0.2,
     // Session Replay: capture 10% of sessions, 100% on error
     replaysSessionSampleRate: 0.1,
     replaysOnErrorSampleRate: 1.0,
     // Only enable in production
     enabled: import.meta.env.PROD,
     // Environment tag
     environment: import.meta.env.MODE,
   });
   ```

3. Update `src/main.tsx` to import instrument FIRST (before any other app code):
   ```ts
   import './instrument';  // Must be first import
   import { StrictMode } from 'react';
   // ... rest of imports
   ```
   Also add Sentry error handlers to createRoot:
   ```ts
   createRoot(document.getElementById('root')!, {
     onUncaughtError: Sentry.reactErrorHandler(),
     onCaughtError: Sentry.reactErrorHandler(),
   }).render(...)
   ```

4. Update `vite.config.ts` to add sentryVitePlugin AFTER other plugins:
   ```ts
   import { sentryVitePlugin } from '@sentry/vite-plugin';
   ```
   Add `build.sourcemap: 'hidden'` and sentryVitePlugin with org/project from env vars `SENTRY_ORG`, `SENTRY_PROJECT`, and `SENTRY_AUTH_TOKEN`.
   Only add the plugin when `SENTRY_AUTH_TOKEN` is present (to avoid breaking local dev builds).

5. Add `VITE_SENTRY_DSN` to `.env.example` with a comment explaining it.

**AVOID:** Do NOT set tracesSampleRate to 1.0 in production — this generates too much data. 0.2 is appropriate for a beta with ~200 users. Do NOT add Sentry to dependencies that would bloat the main chunk — @sentry/react handles tree-shaking.
  </action>
  <verify>npm run build completes without errors and generates source maps. Check that `dist/assets/` contains `.js.map` files.</verify>
  <done>Sentry SDK initialized in instrument.ts, imported first in main.tsx, vite plugin configured for source map upload, build succeeds.</done>
</task>

<task type="auto">
  <name>Task 2: Production hardening — debug cleanup, error boundary, security headers</name>
  <files>src/lib/supabase.ts, src/App.tsx, vercel.json</files>
  <action>
1. Clean up `src/lib/supabase.ts`:
   - Remove the 3 `console.log` debug lines (lines 8-9 and the connection test on lines 23-25)
   - Keep the env var validation throw (that's good)

2. Add Sentry ErrorBoundary to `src/App.tsx`:
   - Import `import * as Sentry from '@sentry/react'`
   - Wrap the main app content (inside QueryClientProvider, around the Router/Routes) with `<Sentry.ErrorBoundary fallback={<ErrorFallback />}>`
   - Create a simple `ErrorFallback` component inline that shows "Er is iets misgegaan" with a reload button
   - Place the ErrorBoundary OUTSIDE the Suspense boundary so it catches chunk loading errors too

3. Enhance `vercel.json` security headers:
   - Add `Referrer-Policy: strict-origin-when-cross-origin`
   - Add `X-XSS-Protection: 0` (modern browsers, CSP is better)
   - Add `Permissions-Policy: camera=(), microphone=(), geolocation=()` (restrict browser APIs not needed)
   - Keep existing X-Content-Type-Options and X-Frame-Options

4. Add `.env.sentry-build-plugin` to `.gitignore` if not already there.

**AVOID:** Do NOT add a Content-Security-Policy header yet — Supabase realtime uses WebSockets and inline styles from Tailwind would need `unsafe-inline`. CSP requires careful testing. Do NOT remove the env var validation in supabase.ts — that's a good production guard.
  </action>
  <verify>npm run build succeeds. Check vercel.json is valid JSON. Verify no console.log statements remain in supabase.ts with `grep -n "console.log" src/lib/supabase.ts` (should return nothing).</verify>
  <done>Debug logs removed from supabase.ts, Sentry ErrorBoundary wrapping app, security headers enhanced in vercel.json, .gitignore updated.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `grep -rn "console.log" src/lib/supabase.ts` returns nothing
- [ ] `src/instrument.ts` exists with Sentry.init()
- [ ] `src/main.tsx` imports instrument.ts first
- [ ] `vite.config.ts` includes sentryVitePlugin (conditional on auth token)
- [ ] `vercel.json` has enhanced security headers and is valid JSON
- [ ] Sentry ErrorBoundary wraps app content in App.tsx
- [ ] No TypeScript errors (`npx tsc --noEmit`)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Sentry SDK configured and ready to receive errors (DSN needed from dashboard)
- Source maps uploaded on production builds (when SENTRY_AUTH_TOKEN is set)
- Debug console.logs removed from production code
- Security headers hardened
</success_criteria>

<output>
After completion, create `.planning/phases/10-beta-deployment-monitoring/10-01-SUMMARY.md`
</output>
