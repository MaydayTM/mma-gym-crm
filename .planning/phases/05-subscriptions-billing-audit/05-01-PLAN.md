---
phase: 05-subscriptions-billing-audit
plan: 01
type: execute
depends_on: []
files_modified:
  - src/hooks/useAssignSubscription.ts
  - src/hooks/useSubscriptions.ts
  - src/hooks/useMemberSubscriptions.ts
  - src/pages/MemberDetail.tsx
  - src/components/members/SubscriptionActions.tsx
---

<objective>
Audit and fix the subscription lifecycle: creation (admin assign), status transitions (cancel, freeze, unfreeze, expire), MRR calculation, and subscription display on member detail.

Purpose: Ensure subscriptions can be fully managed by admins - not just created but also cancelled, frozen, and unfrozen. Fix MRR stat calculation bug.
Output: Working subscription lifecycle with cancel/freeze/unfreeze actions, correct MRR stats.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-roles-permissions-audit/04-03-SUMMARY.md

# Key source files
@src/hooks/useAssignSubscription.ts
@src/hooks/useSubscriptions.ts
@src/hooks/useMemberSubscriptions.ts
@src/pages/MemberDetail.tsx
@src/pages/Subscriptions.tsx

**Tech stack available:** Vite + React 18 + TypeScript, Supabase, TanStack Query, Tailwind CSS
**Established patterns:** usePermissions for action gating, conditional rendering (hide buttons for non-privileged users)
**Constraining decisions:**
- Phase 4: Action buttons hidden (not disabled) for non-privileged users
- Phase 4: canEditMembers gates subscription-related actions
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add subscription cancel/freeze/unfreeze mutations and fix MRR calculation</name>
  <files>src/hooks/useSubscriptions.ts, src/hooks/useMemberSubscriptions.ts</files>
  <action>
  1. In useSubscriptions.ts, fix the MRR calculation bug: currently `stats.total_mrr` sums `final_price` (which is total contract price, not monthly), then the UI divides by 12. Instead, calculate monthly rate per subscription: `final_price / duration_months` for each active subscription, sum those. Remove the `/12` division from Subscriptions.tsx.

  2. Create a new `useCancelSubscription` mutation in useSubscriptions.ts:
     - Updates member_subscriptions.status to 'cancelled', sets cancelled_at to now()
     - If no other active subscriptions exist for the member, update member.status to 'cancelled'
     - Invalidates subscription and member queries

  3. Create `useFreezeSubscription` mutation:
     - Updates status to 'frozen', sets frozen_until to provided date
     - Invalidates queries

  4. Create `useUnfreezeSubscription` mutation:
     - Updates status back to 'active', clears frozen_until
     - Extends end_date by the frozen duration (difference between freeze date and unfreeze date)
     - Invalidates queries

  All mutations should use optimistic query invalidation pattern matching existing useAssignSubscription.
  </action>
  <verify>
  - `npm run build` passes with no TypeScript errors
  - New hooks export correctly from useSubscriptions.ts
  - MRR calculation in Subscriptions.tsx no longer divides by 12
  </verify>
  <done>
  - useCancelSubscription, useFreezeSubscription, useUnfreezeSubscription mutations exist and compile
  - MRR stat shows correct monthly recurring revenue (sum of final_price/duration_months for active subs)
  </done>
</task>

<task type="auto">
  <name>Task 2: Add subscription action buttons to MemberDetail subscription section</name>
  <files>src/pages/MemberDetail.tsx, src/components/members/SubscriptionActions.tsx</files>
  <action>
  1. Create SubscriptionActions component that receives a CombinedSubscription and renders action buttons based on status:
     - Active subscription: Show "Pauzeren" (freeze) and "Opzeggen" (cancel) buttons
     - Frozen subscription: Show "Hervatten" (unfreeze) button
     - Cancelled/expired: No actions (read-only)
     - Gate all actions behind canEditMembers permission (from usePermissions)
     - Style: small outline buttons matching existing dark theme (rounded-full, border-white/20)

  2. Freeze action should open a simple date picker modal for frozen_until date. Use a basic modal pattern matching existing modals in the codebase.

  3. Cancel action should show a confirmation dialog before proceeding ("Weet je zeker dat je dit abonnement wilt opzeggen?")

  4. Integrate SubscriptionActions into MemberDetail.tsx subscription list section - add action buttons next to each subscription row.

  Do NOT add subscription creation here (that already exists via the assign flow). Only lifecycle management actions.
  </action>
  <verify>
  - `npm run build` passes
  - SubscriptionActions component renders conditionally based on subscription status
  - Actions are permission-gated (hidden for non-staff users)
  </verify>
  <done>
  - Active subscriptions show freeze + cancel buttons (staff only)
  - Frozen subscriptions show unfreeze button (staff only)
  - Cancel has confirmation dialog
  - Freeze has date picker
  - All mutations trigger and invalidate queries correctly
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Subscription lifecycle management with cancel/freeze/unfreeze actions on MemberDetail, fixed MRR calculation</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Visit: http://localhost:5173/subscriptions
    3. Check: MRR stat should show monthly rate (not total/12)
    4. Navigate to a member with an active subscription
    5. Verify: "Pauzeren" and "Opzeggen" buttons visible (as admin)
    6. Test freeze: Click "Pauzeren", select a date, confirm - subscription shows as "Gepauzeerd"
    7. Test unfreeze: Click "Hervatten" on frozen subscription - returns to active
    8. Test cancel: Click "Opzeggen", confirm dialog appears, confirm - subscription shows as "Opgezegd"
    9. Log in as a fighter role - verify action buttons are hidden
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] MRR calculation is mathematically correct (monthly, not total/12)
- [ ] Cancel, freeze, unfreeze mutations work end-to-end
- [ ] Permission gating works (staff sees actions, fighters don't)
- [ ] Member status updates when last subscription cancelled
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors introduced
- Subscription lifecycle fully manageable from MemberDetail page
  </success_criteria>

<output>
After completion, create `.planning/phases/05-subscriptions-billing-audit/05-01-SUMMARY.md`
</output>
