---
phase: 05-subscriptions-billing-audit
plan: 02
type: execute
depends_on: []
files_modified:
  - supabase/functions/create-mollie-payment/index.ts
  - supabase/functions/mollie-webhook/index.ts
  - src/pages/checkout/PlanCheckout.tsx
  - src/pages/checkout/CheckoutSuccess.tsx
---

<objective>
Audit and harden the Mollie payment flow and checkout session pipeline for security, error handling, and data integrity.

Purpose: Ensure the public-facing checkout and payment webhook are secure, handle edge cases, and don't create orphaned or inconsistent data.
Output: Hardened Mollie integration with security fixes, improved error handling, and validated checkout flow.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Key source files
@supabase/functions/create-mollie-payment/index.ts
@supabase/functions/mollie-webhook/index.ts
@src/pages/checkout/PlanCheckout.tsx
@src/pages/checkout/CheckoutSuccess.tsx
@src/pages/checkout/CheckoutCancel.tsx

**Tech stack available:** Supabase Edge Functions (Deno), supabase-js v2.39.3, Mollie API v2
**Constraining decisions:**
- Edge Functions pinned to supabase-js v2.39.3
- Mollie is primary payment provider (Stripe deferred)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Harden create-mollie-payment edge function security</name>
  <files>supabase/functions/create-mollie-payment/index.ts</files>
  <action>
  Security audit findings to fix:

  1. **Use SERVICE_ROLE_KEY instead of ANON_KEY**: The function currently creates a Supabase client with SUPABASE_ANON_KEY to read checkout_sessions. Since checkout_sessions may have restrictive RLS, use SUPABASE_SERVICE_ROLE_KEY (like mollie-webhook already does). This is an edge function, not frontend code, so SERVICE_ROLE_KEY is appropriate.

  2. **Validate checkout session ownership**: Add a check that the checkout_session has not expired (e.g., created_at within last 24 hours) and payment_status is 'pending'. The existing payment_status check is good - keep it.

  3. **Validate amount**: Ensure session.final_total is a positive number > 0 before creating payment. Reject zero or negative amounts.

  4. **Rate limiting hint**: Add a comment noting that Supabase Edge Function rate limiting should be configured in production (not code-level, but operational awareness).

  5. **Sanitize description**: The payment description uses plan/age group names from DB. These should be safe, but truncate to max 255 chars (Mollie limit).

  Keep the CORS headers as-is (needed for public checkout page).
  </action>
  <verify>
  - Edge function code compiles (check syntax)
  - SERVICE_ROLE_KEY used instead of ANON_KEY
  - Amount validation present
  - Session freshness check present
  </verify>
  <done>
  - create-mollie-payment uses SERVICE_ROLE_KEY
  - Validates positive amount, session freshness, and payment_status
  - Description truncated to safe length
  </done>
</task>

<task type="auto">
  <name>Task 2: Harden mollie-webhook and audit checkout flow pages</name>
  <files>supabase/functions/mollie-webhook/index.ts, src/pages/checkout/PlanCheckout.tsx, src/pages/checkout/CheckoutSuccess.tsx</files>
  <action>
  **Webhook hardening:**

  1. **Verify webhook authenticity**: Mollie webhooks don't use signatures for verification. Instead, the webhook only receives a payment ID and we fetch the actual payment status from Mollie's API (already done correctly). Add a comment documenting this security pattern.

  2. **Idempotency**: Add a check before creating member/subscription - if checkout_sessions.payment_status is already 'completed', return 200 immediately without creating duplicates. Currently if Mollie retries the webhook, it could create duplicate subscriptions.

  3. **Revenue record**: The webhook creates a member and subscription on payment success but does NOT create a revenue record. Add revenue record creation matching the pattern in useAssignSubscription (category: 'subscription', amount: session.final_total).

  4. **Member status update**: When creating a subscription for an existing member, also set their status to 'active' if currently 'cancelled' or 'lead' (matching useAssignSubscription pattern).

  **Checkout flow audit:**

  5. **PlanCheckout.tsx**: Verify form validation exists for required fields (first_name, last_name, email, phone, birth_date). Check that email format validation exists. Check that the checkout session is created before redirect to Mollie.

  6. **CheckoutSuccess.tsx**: Verify it handles the case where payment is still pending (Mollie webhook hasn't arrived yet). Should poll or show a "payment being processed" state rather than immediately showing success.
  </action>
  <verify>
  - `npm run build` passes
  - Webhook has idempotency check
  - Revenue record creation added to webhook
  - CheckoutSuccess handles pending state
  </verify>
  <done>
  - Webhook is idempotent (no duplicate subscriptions on retry)
  - Revenue record created on successful payment
  - Member status updated to active on payment success
  - CheckoutSuccess handles pending payment gracefully
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Hardened Mollie payment flow with security fixes, idempotency, revenue tracking, and improved checkout UX</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Visit: http://localhost:5173/checkout/plans
    3. Select an age group, choose a plan, fill in details
    4. Verify: Form validation rejects empty required fields and invalid email
    5. Review the edge function code changes:
       - create-mollie-payment: Uses SERVICE_ROLE_KEY, validates amount
       - mollie-webhook: Has idempotency check, creates revenue record
    6. Visit /checkout/success?session_id=invalid - should handle gracefully
    7. Confirm: No build errors, checkout flow renders correctly
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] create-mollie-payment uses SERVICE_ROLE_KEY
- [ ] mollie-webhook has idempotency guard
- [ ] Revenue record created on successful payment
- [ ] Checkout form has proper validation
- [ ] CheckoutSuccess handles pending payment state
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No security vulnerabilities in payment flow
- Payment flow handles edge cases (duplicates, pending, invalid sessions)
  </success_criteria>

<output>
After completion, create `.planning/phases/05-subscriptions-billing-audit/05-02-SUMMARY.md`
</output>
