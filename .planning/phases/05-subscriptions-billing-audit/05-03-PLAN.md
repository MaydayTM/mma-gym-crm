---
phase: 05-subscriptions-billing-audit
plan: 03
type: execute
depends_on: []
files_modified:
  - src/pages/SubscriptionsManage.tsx
  - src/hooks/useSubscriptionAdmin.ts
  - supabase/functions/door-validate/index.ts
---

<objective>
Audit the pricing matrix admin interface for data integrity and verify subscription-gated door access correctly blocks expired/cancelled members.

Purpose: Ensure pricing configuration is robust and that door access accurately reflects subscription status.
Output: Verified pricing admin with data integrity checks, confirmed door access gating.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Key source files
@src/pages/SubscriptionsManage.tsx
@src/hooks/useSubscriptionAdmin.ts
@src/components/subscriptions/PricingMatrixTab.tsx
@src/components/subscriptions/DiscountsTab.tsx
@supabase/functions/door-validate/index.ts

**Tech stack available:** Vite + React 18 + TypeScript, Supabase, TanStack Query
**Constraining decisions:**
- Phase 4: canEditMembers gates subscription management actions
- Owner tenant (Reconnect) bypasses all module checks
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit pricing matrix admin for data integrity</name>
  <files>src/pages/SubscriptionsManage.tsx, src/hooks/useSubscriptionAdmin.ts, src/components/subscriptions/PricingMatrixTab.tsx</files>
  <action>
  Review and fix data integrity issues in the subscription admin:

  1. **Delete cascading**: Verify that deleting an age_group or plan_type that has pricing_matrix entries either cascades or blocks with a user-friendly error. Check the database foreign key constraints. If ON DELETE CASCADE is set, add a confirmation warning in the UI: "Dit verwijdert ook X gekoppelde prijzen." If no cascade, catch the FK error and show "Kan niet verwijderen: er zijn nog gekoppelde prijzen."

  2. **Pricing matrix uniqueness**: Check that the pricing matrix enforces uniqueness on (age_group_id, plan_type_id, duration_months) to prevent duplicate pricing entries. If the DB constraint exists, catch the unique violation error in useCreatePricing and show "Deze combinatie bestaat al." If no constraint exists, add validation in the mutation before insert.

  3. **Discount validation**: In DiscountsTab/useDiscounts, verify that discount percentages are 0-100 and fixed amounts are non-negative. Add client-side validation if missing.

  4. **Permission gating**: Verify SubscriptionsManage page is properly gated (should already be via RoleGuard from Phase 4, but confirm). Check that all CRUD operations in useSubscriptionAdmin require appropriate permissions.

  Keep changes minimal - this is an audit, not a redesign. Only fix actual bugs and missing validations.
  </action>
  <verify>
  - `npm run build` passes
  - Attempt to create duplicate pricing entry shows error message
  - Discount validation rejects invalid values
  - Delete operations show appropriate warnings or handle FK errors
  </verify>
  <done>
  - Delete operations handle FK constraints gracefully
  - Pricing matrix prevents duplicate entries
  - Discount values validated (0-100% / non-negative amounts)
  - Admin page properly permission-gated
  </done>
</task>

<task type="auto">
  <name>Task 2: Audit subscription-gated door access</name>
  <files>supabase/functions/door-validate/index.ts</files>
  <action>
  Review the door-validate edge function and verify it correctly checks subscription status:

  1. **Read the function**: Understand the full validation chain (member exists, access_enabled, member status, active subscription).

  2. **Expired subscription check**: Verify the SQL query checks `end_date >= CURRENT_DATE` AND `status = 'active'`. If it only checks status but not end_date, subscriptions that passed their end_date but weren't manually expired would still grant access. Fix if needed.

  3. **Frozen subscription handling**: Verify that frozen subscriptions do NOT grant door access. The status check should only allow 'active', not 'frozen'.

  4. **Team bypass**: Confirm that admin/medewerker/coordinator/coach roles bypass subscription check correctly. This should be based on member.role, not subscription existence.

  5. **Log denial reasons**: Verify that when access is denied, the denial_reason in door_access_logs is specific (e.g., 'no_active_subscription', 'subscription_expired', 'access_disabled') rather than generic.

  6. **Token expiry**: Check that expired QR tokens are rejected. Verify the JWT expiry is checked.

  If the check_member_door_access is a database function (not just in the edge function), also review that SQL function.
  </action>
  <verify>
  - door-validate checks both subscription status AND end_date
  - Frozen subscriptions are explicitly excluded from access
  - Team roles bypass subscription requirement
  - Denial reasons are specific in access logs
  </verify>
  <done>
  - Door access correctly denies expired, cancelled, and frozen subscriptions
  - Team roles (admin, medewerker, coordinator, coach) bypass subscription check
  - Access logs contain specific denial reasons
  - QR token expiry is validated
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] Pricing admin handles edge cases (duplicates, FK constraints, invalid values)
- [ ] Door access function correctly validates subscription status + end_date
- [ ] No security gaps in access control
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No data integrity issues in pricing admin
- Door access accurately reflects subscription status
- Phase 5 complete
  </success_criteria>

<output>
After completion, create `.planning/phases/05-subscriptions-billing-audit/05-03-SUMMARY.md`
</output>
