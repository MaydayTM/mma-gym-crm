---
phase: 04-roles-permissions-audit
plan: 03
type: execute
depends_on: ["04-01", "04-02"]
files_modified: [src/pages/Leads.tsx, src/pages/Schedule.tsx, src/pages/CheckIn.tsx, src/pages/Subscriptions.tsx, src/pages/SubscriptionsManage.tsx, src/pages/Reports.tsx, src/pages/Team.tsx, src/pages/Settings.tsx, src/components/layout/Sidebar.tsx]
---

<objective>
Add permission checks to all remaining pages, audit sidebar visibility, and perform full verification.

Purpose: Complete the permission enforcement across the entire app. After Plans 01 and 02, routes are guarded and member management is locked down. This plan handles the remaining pages and ensures sidebar visibility matches the route guards.
Output: All pages have consistent permission enforcement. Sidebar matches route access. Full human verification.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-roles-permissions-audit/04-01-SUMMARY.md
@.planning/phases/04-roles-permissions-audit/04-02-SUMMARY.md

@src/hooks/usePermissions.ts
@src/components/layout/Sidebar.tsx
@src/pages/Leads.tsx
@src/pages/Schedule.tsx
@src/pages/CheckIn.tsx
@src/pages/Subscriptions.tsx
@src/pages/Reports.tsx
@src/pages/Team.tsx
@src/pages/Settings.tsx

**Access matrix (from Plan 04-01 route guards):**
- Leads: staff only (canManageLeads)
- Subscriptions/SubscriptionsManage: staff only (canEditMembers)
- CheckIn: staff only (canCheckInMembers)
- Reports: admin only (canManageFinances - contains financial data)
- Schedule: viewable by team+fighters (canViewSchedule), editable by staff (canManageSchedule)
- Settings: staff only (isStaff)
- Team: admin only (isAdmin)
- Door-test: admin only (isAdmin)

**Sidebar current state:**
- Only "Team" has `adminOnly: true`
- All other items visible to all authenticated users
- Shop/Email have module-based visibility
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add action-level permission checks to remaining pages</name>
  <files>src/pages/Leads.tsx, src/pages/Schedule.tsx, src/pages/CheckIn.tsx, src/pages/Subscriptions.tsx, src/pages/SubscriptionsManage.tsx, src/pages/Reports.tsx, src/pages/Team.tsx, src/pages/Settings.tsx</files>
  <action>
For each page, import usePermissions and add permission checks to action buttons. The route-level RoleGuard (from Plan 04-01) already blocks unauthorized access, but we add action-level checks as defense-in-depth:

**Leads.tsx:**
- Add/edit/delete lead actions: gate with canManageLeads
- Lead conversion to member: gate with canEditMembers
- If page has read-only view for non-staff, show it. Otherwise RoleGuard handles access.

**Schedule.tsx:**
- "Add class" / "Edit class" / "Delete class" buttons: gate with canManageSchedule
- View schedule (reading): allowed for canViewSchedule (already handled by RoleGuard)
- Fighters should see schedule read-only (no add/edit/delete buttons)

**CheckIn.tsx:**
- All check-in actions: gate with canCheckInMembers
- This page is staff-only via RoleGuard, but add checks for safety

**Subscriptions.tsx & SubscriptionsManage.tsx:**
- Create/edit/cancel subscription actions: gate with canEditMembers
- View subscriptions list: gate handled by RoleGuard

**Reports.tsx:**
- Financial reports: gate with canManageFinances
- Non-financial reports (member stats, check-in stats): consider showing to staff too
- If the page mixes financial and non-financial, use canManageFinances for financial sections

**Team.tsx:**
- All actions (add team member, change roles): gate with isAdmin
- Already guarded by RoleGuard but add inline checks

**Settings.tsx:**
- Settings has multiple tabs/sections. If some are admin-only (like gym profile, billing), gate those sections with isAdmin
- General settings accessible to staff

For each page: review what action buttons/forms exist, then wrap them with the minimal permission check needed. Do NOT restructure pages or change layouts - only add conditional rendering.
  </action>
  <verify>npm run build succeeds. Spot-check Schedule.tsx has canManageSchedule gating on edit buttons.</verify>
  <done>All remaining pages have action-level permission checks. Build passes. No TypeScript errors.</done>
</task>

<task type="auto">
  <name>Task 2: Audit and fix sidebar visibility to match route guards</name>
  <files>src/components/layout/Sidebar.tsx</files>
  <action>
The sidebar currently only hides "Team" for non-admins. Update sidebar item visibility to match the route guards from Plan 04-01:

Update the navigation item data structure to support role-based visibility. Options:
1. Add a `permission` field to nav items (preferred - uses usePermissions keys)
2. Or add `roles` array to nav items

Apply these visibility rules:
- **Dashboard**: All authenticated (no change)
- **Leden (Members)**: All authenticated (no change - read access)
- **Leads**: Staff only (add permission check)
- **Abonnementen (Subscriptions)**: Staff only (add permission check)
- **Rooster (Schedule)**: Team + fighters (canViewSchedule)
- **Reservaties (Reservations)**: All authenticated (no change)
- **Check-in**: Staff only (add permission check)
- **Rapportages (Reports)**: Admin only (add permission check)
- **Taken (Tasks)**: All authenticated (no change)
- **Team**: Admin only (already has adminOnly)
- **Instellingen (Settings)**: Staff only (add permission check)
- **Shop/Email**: Keep existing module-based logic
- **GymScreen**: All authenticated (no change)
- **Kitana**: All authenticated (no change)
- **Door-test**: Remove from sidebar or admin-only (it's a dev/test page)

Implementation approach:
- Import usePermissions in Sidebar
- Replace the simple `adminOnly` check with a more flexible `permission` or `requiredRole` field on nav items
- Update the `visibleItems` filter to check permissions
- Keep the existing module-based logic for Shop/Email untouched

Ensure the sidebar still looks correct for all roles - no empty groups, no visual glitches when items are hidden.
  </action>
  <verify>npm run build succeeds. Sidebar renders correctly. Staff items hidden for fighters.</verify>
  <done>Sidebar visibility matches route guards exactly. No empty groups. Build passes. All roles see appropriate navigation.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete role-based access control across all pages and sidebar</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Log in as admin (your account) - verify you see ALL sidebar items and can access all pages
    3. Temporarily change your role to 'fighter' in Supabase dashboard (members table)
    4. Refresh the app - verify:
       a. Sidebar shows only: Dashboard, Leden, Rooster, Reservaties, Taken, Kitana, GymScreen
       b. Navigating to /leads shows "Geen toegang" message
       c. Navigating to /reports shows "Geen toegang" message
       d. Navigating to /team shows "Geen toegang" message
       e. Member detail page: edit button only visible on YOUR OWN profile
       f. Member detail page: delete button NOT visible
       g. Members list: "Add member" button NOT visible
       h. Schedule page: read-only (no add/edit class buttons)
    5. Change your role back to 'admin' in Supabase dashboard
    6. Refresh and verify full access is restored
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build` succeeds without errors
- [ ] All pages have permission checks on action buttons
- [ ] Sidebar visibility matches route guards
- [ ] Human verified with fighter role
- [ ] Admin access fully restored
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Permission enforcement is consistent across routes, pages, sidebar
- Phase 4 complete
</success_criteria>

<output>
After completion, create `.planning/phases/04-roles-permissions-audit/04-03-SUMMARY.md`
</output>
