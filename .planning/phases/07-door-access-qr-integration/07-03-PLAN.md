---
phase: 07-door-access-qr-integration
plan: 03
type: execute
depends_on: ["07-01", "07-02"]
files_modified:
  - hardware/esp32-door-access/door_access_wifi.ino
---

<objective>
Update ESP32 firmware for production mode, fix the QR data format issue, and perform full hardware integration testing.

Purpose: The ESP32 is in test mode (opens door for any QR scan). It needs to switch to production mode calling the door-validate API. Critical issue: the Wiegand scanner outputs numeric card codes, but the system expects JWT strings — this protocol mismatch must be resolved.
Output: Production-ready ESP32 firmware, verified end-to-end door access flow.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-door-access-qr-integration/07-01-SUMMARY.md
@.planning/phases/07-door-access-qr-integration/07-02-SUMMARY.md

# Key source files:
@hardware/esp32-door-access/door_access_wifi.ino
@docs/door-access-next-steps.md
@docs/door-access-esp32-setup.md

**Constraining decisions:**
- Plan 01: door-validate now requires apikey header
- Plan 01: door-validate response shape: { allowed, reason, member_name }
- ESP32 hardware: TTGO T-Display V1.1, Wiegand QR Scanner on GPIO25/26, Relay on GPIO27
- WiFi: "Msd" network, tested and working

**Critical issue: QR data format mismatch**
The Wiegand QR scanner outputs data as 26-bit card codes (numeric, e.g., 47830998). But the system generates JWT tokens (long base64 strings like "eyJhbGciOiJIUzI1NiJ9...").

The Wiegand protocol sends data bit-by-bit via D0/D1 pulses. When scanning a QR code containing a JWT string, the scanner may:
- (a) Convert the QR content to a numeric hash (losing the original JWT)
- (b) Send the raw bytes as a long Wiegand sequence (hundreds of bits instead of 26)
- (c) Use a different output mode for QR vs card (ASCII mode via serial)

The current ISR code assumes 26-bit Wiegand. A JWT is ~200+ characters (1600+ bits). The scanner likely outputs ASCII bytes when reading QR codes. Need to investigate and handle this.

Possible solutions:
1. **Short numeric tokens**: Instead of JWT QR codes, generate short numeric codes (6-8 digits) and validate those. Simpler but less secure.
2. **ASCII mode on scanner**: Many Wiegand QR scanners support ASCII output mode for long QR data. The ESP32 code needs to buffer ASCII characters instead of treating them as 26-bit card codes.
3. **Serial output**: Some scanners have a secondary serial (UART) output for long data. Check if the scanner supports this.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Investigate QR scanner data format and update ESP32 firmware</name>
  <files>hardware/esp32-door-access/door_access_wifi.ino</files>
  <action>
  The QR scanner likely sends JWT data as multi-byte Wiegand (8-bit per character, not 26-bit card format). Update the ESP32 firmware:

  1. **Detect data length**: If bitCount > 100, treat as QR/ASCII data (not a card). If bitCount == 26, treat as standard Wiegand card.

  2. **QR data reconstruction**: For QR data, the scanner sends each ASCII character as 8 bits via Wiegand. Reconstruct the string:
     - Buffer incoming bits in a byte array
     - After transmission ends (100ms timeout), convert bytes to string
     - The resulting string should be the JWT token

  3. **Update production mode code**:
     - Switch from test mode to production mode (uncomment API validation)
     - Use the reconstructed JWT string (not `String(cardCode)`)
     - Add apikey header to HTTP request (from Plan 01: door-validate requires it)
     - Add the ANON_KEY as a constant (this is a public key, safe to embed in firmware)

  4. **Update API call**: Add apikey header:
     ```cpp
     http.addHeader("apikey", SUPABASE_ANON_KEY);
     ```

  5. **Add visual/audio feedback**:
     - Green: Door opens (already done via relay)
     - Red/denied: Print to Serial (LED or buzzer can be added later)
     - WiFi status: Print reconnection attempts

  6. **Handle WiFi failure gracefully**: If WiFi is down, deny access and log to Serial. Don't crash or hang.

  Avoid: Changing the wiring or pin configuration. Avoid removing the WiFi reconnection logic. Avoid hardcoding the SERVICE_ROLE_KEY in the firmware (only use ANON_KEY).

  NOTE: The exact QR scanner behavior when reading long QR codes needs to be verified with hardware. The Wiegand ISR code may need adjustment based on how many bits the scanner actually sends for a JWT QR code. Document assumptions and add Serial debug output to help with hardware testing.
  </action>
  <verify>Code compiles conceptually (no Arduino build in CI). Production mode uncommented. apikey header added. QR buffer handles long data.</verify>
  <done>ESP32 firmware updated for production mode with long QR data handling, apikey header, and WiFi resilience</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Flash ESP32 with updated production firmware</action>
  <instructions>
    The updated firmware is at: hardware/esp32-door-access/door_access_wifi.ino

    Steps:
    1. Open Arduino IDE
    2. Open the file: hardware/esp32-door-access/door_access_wifi.ino
    3. Select Board: "TTGO T-Display" (ESP32)
    4. Connect ESP32 via USB
    5. Upload the sketch
    6. Open Serial Monitor (115200 baud)
    7. Verify: "RECONNECT ACADEMY - DOOR ACCESS" appears
    8. Verify: WiFi connects successfully
    9. Verify: ">>> READY - Scan QR code to enter <<<" appears

    If upload fails, check:
    - Correct board selected in Tools > Board
    - Correct port selected in Tools > Port
    - Required libraries installed: WiFi, HTTPClient, ArduinoJson
  </instructions>
  <verification>Serial Monitor shows WiFi connected and ready status</verification>
  <resume-signal>Type "flashed" when ESP32 is running the new firmware, or describe any issues</resume-signal>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete door access system: Edge Functions deployed (Plan 01), frontend updated (Plan 02), ESP32 in production mode (this plan)</what-built>
  <how-to-verify>
    **Test 1: QR Code Generation (Frontend)**
    1. Run: npm run dev
    2. Login as admin
    3. Go to any active member's detail page
    4. Find "Deur Toegang" card
    5. Verify: QR code displays with countdown timer
    6. Verify: No "Test modus" banner shown

    **Test 2: Door Scan - Valid Member**
    1. On member detail, note the QR code is displayed
    2. Scan the QR code with the Wiegand scanner on ESP32
    3. Expected: Serial Monitor shows "WELCOME [member name]", door opens for 5 seconds
    4. Expected: DoorAccessCard shows new access log entry "Toegang verleend"

    **Test 3: Door Scan - Expired/Invalid QR**
    1. Wait for QR code to expire (15 minutes) or generate a new one (old one becomes invalid)
    2. Scan the old QR code
    3. Expected: Serial Monitor shows "ACCESS DENIED", door stays closed
    4. Expected: Access log shows "Toegang geweigerd" with reason

    **Test 4: Member Without Subscription**
    1. Find a member without active subscription (fighter role)
    2. Try to generate QR code
    3. Expected: Error message "Geen actief abonnement" or similar

    **Test 5: Staff Member Without Subscription**
    1. Find a coach or medewerker without active subscription
    2. Generate QR code — should succeed (team role bypass)
    3. Scan at door — should open

    **If QR scanner doesn't read the JWT QR code:**
    This means the Wiegand protocol can't handle the long data. Report what the Serial Monitor shows (bitCount, raw data). We may need to switch to short numeric tokens instead.
  </how-to-verify>
  <resume-signal>Type "approved" if all tests pass, or describe which tests failed and what Serial Monitor showed</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] ESP32 firmware in production mode (API validation enabled)
- [ ] ESP32 sends apikey header with requests
- [ ] QR code data correctly transmitted from scanner to ESP32
- [ ] Door opens for valid member with active subscription
- [ ] Door stays closed for invalid/expired tokens
- [ ] Team roles bypass subscription check
- [ ] Access logs recorded in database
- [ ] Full end-to-end flow works: Generate QR → Display → Scan → Validate → Open/Deny
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- ESP32 production mode working end-to-end
- Phase 7 complete: Door Access & QR Integration verified
</success_criteria>

<output>
After completion, create `.planning/phases/07-door-access-qr-integration/07-03-SUMMARY.md`
</output>
