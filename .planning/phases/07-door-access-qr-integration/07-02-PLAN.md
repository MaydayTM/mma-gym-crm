---
phase: 07-door-access-qr-integration
plan: 02
type: execute
depends_on: ["07-01"]
files_modified:
  - src/components/members/DoorAccessCard.tsx
  - src/pages/DoorTest.tsx
---

<objective>
Fix the check_member_door_access database function, audit door access logging, and verify frontend components work with the deployed Edge Functions.

Purpose: The DB function is missing team role bypass (known issue from ISSUES.md), and frontend components need to be tested against the now-deployed Edge Functions with auth headers and hash-based token storage.
Output: DB function fixed, frontend components updated to pass auth headers, DoorAccessCard and DoorTest verified working.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/ISSUES.md
@.planning/phases/07-door-access-qr-integration/07-01-SUMMARY.md

# Key source files:
@supabase/migrations/043_door_access.sql
@supabase/migrations/056_security_fixes.sql
@src/components/members/DoorAccessCard.tsx
@src/pages/DoorTest.tsx
@src/pages/MemberDetail.tsx

**Tech stack available:** supabase-js@2.39.3, qrcode.react, lucide-react
**Established patterns:**
- Edge Function calls use supabase.functions.invoke() or fetch with auth headers
- Auth token from supabase.auth.getSession()
- Permission gating via usePermissions hook

**Constraining decisions:**
- Phase 5 (05-03): check_member_door_access missing team role bypass — logged in ISSUES.md
- STATE.md: Migration sync mismatch between local and remote — new migrations may need SQL Editor
- Phase 7 Plan 01: door-token now requires auth Bearer token

**Issues being addressed:**
- ISSUES.md: check_member_door_access missing team role bypass
- DoorAccessCard calls door-token without auth headers (will fail after Plan 01 changes)
- Migration sync issue may prevent pushing DB function fix via migration
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix check_member_door_access and update DoorAccessCard auth</name>
  <files>src/components/members/DoorAccessCard.tsx</files>
  <action>
  Two changes:

  1. **Fix check_member_door_access DB function**: Since migration sync issues exist (STATE.md blocker), apply the fix via Supabase SQL Editor (not a new migration file). Create the fix as a standalone SQL file in `supabase/sql/` for documentation, but instruct to apply via SQL Editor.

     The fix adds team role bypass before subscription check:
     ```sql
     CREATE OR REPLACE FUNCTION check_member_door_access(p_member_id UUID)
     -- Add after member status check, before subscription check:
     -- IF v_member.role IN ('admin', 'medewerker', 'coordinator', 'coach') THEN
     --   RETURN QUERY SELECT true, member_name, NULL;
     --   RETURN;
     -- END IF;
     ```

     Create `supabase/sql/fix_door_access_team_bypass.sql` with the complete CREATE OR REPLACE FUNCTION statement. Read the full function from migration 043 first to get the exact signature and body.

  2. **Update DoorAccessCard to pass auth headers**: The door-token Edge Function now requires a Bearer token. Update the fetch call in DoorAccessCard:
     - Get the current session token: `const { data: { session } } = await supabase.auth.getSession()`
     - Add headers: `Authorization: Bearer ${session?.access_token}`, `apikey: import.meta.env.VITE_SUPABASE_ANON_KEY`
     - Handle 401 response: show "Sessie verlopen, log opnieuw in" error message
     - The response shape (qr_token, expires_in, member_name) hasn't changed, so no other updates needed

  Avoid: Creating a new migration file (migration sync issue). Avoid changing the QR code display logic or timer — only the fetch call needs auth headers.
  </action>
  <verify>
  - DoorAccessCard fetch includes Authorization and apikey headers
  - SQL fix file exists at supabase/sql/fix_door_access_team_bypass.sql
  - `npm run build` passes without errors
  </verify>
  <done>DoorAccessCard passes auth headers to door-token, SQL fix documented for manual application</done>
</task>

<task type="auto">
  <name>Task 2: Update DoorTest page and verify access log display</name>
  <files>src/pages/DoorTest.tsx</files>
  <action>
  1. **Audit DoorTest page**: Read DoorTest.tsx and verify:
     - It's restricted to admin role (should be behind RoleGuard or permission check)
     - It correctly calls door-validate (this is an admin testing tool, so it should use service role or direct DB queries rather than simulating ESP32)
     - Test scenarios cover: valid member with subscription, valid member without subscription, team member without subscription, inactive member, member with door_access_enabled=false

  2. **Update if needed**: If DoorTest calls door-validate directly (simulating ESP32), it needs the apikey header added (from Plan 01 changes). Update the fetch call.

  3. **Remove test mode banner**: In DoorAccessCard, there's a "Test modus" amber banner at line 211-214. This should be removed or conditioned on whether DOOR_JWT_SECRET is configured. Since we can't check that from frontend, remove the static test banner entirely — the system is now in production mode.

  4. **Verify denial reason display**: Ensure DoorAccessCard's `formatDenialReason` function handles `no_active_subscription` (Plan 01 fixed the response from `no_subscription` to `no_active_subscription`). Check that the mapping exists.

  Avoid: Rewriting DoorTest page entirely — just audit and fix the specific issues. Avoid adding new features to DoorAccessCard.
  </action>
  <verify>
  - DoorTest is admin-restricted
  - DoorTest passes apikey header if calling door-validate
  - "Test modus" banner removed from DoorAccessCard
  - `no_active_subscription` mapped in formatDenialReason
  - `npm run build` passes
  </verify>
  <done>DoorTest admin-restricted, auth headers correct, test banner removed, denial reasons consistent</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] check_member_door_access fix SQL file created
- [ ] DoorAccessCard passes auth headers to door-token
- [ ] DoorAccessCard handles 401 gracefully
- [ ] DoorTest page admin-restricted
- [ ] "Test modus" banner removed
- [ ] `no_active_subscription` denial reason mapped
- [ ] `npm run build` succeeds
- [ ] ISSUES.md entry can be marked as addressed (with note: apply SQL via Editor)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors
- Frontend components ready for production door access
</success_criteria>

<output>
After completion, create `.planning/phases/07-door-access-qr-integration/07-02-SUMMARY.md`
</output>
