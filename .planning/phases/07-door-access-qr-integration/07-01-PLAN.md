---
phase: 07-door-access-qr-integration
plan: 01
type: execute
depends_on: []
files_modified:
  - supabase/functions/door-token/index.ts
  - supabase/functions/door-validate/index.ts
---

<objective>
Audit and fix security issues in door-token and door-validate Edge Functions, then deploy them to production.

Purpose: The door access Edge Functions have critical security issues that must be fixed before enabling production mode. door-token lacks authentication (anyone with a member_id can generate tokens), and door-validate compares plaintext qr_token but migration 056 stores hashed tokens — causing a mismatch that would reject all valid tokens.
Output: Both Edge Functions hardened and deployed, DOOR_JWT_SECRET set in Supabase secrets.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-subscriptions-billing-audit/05-03-SUMMARY.md
@.planning/phases/06-email-account-claim-testing/06-01-SUMMARY.md

# Key source files:
@supabase/functions/door-token/index.ts
@supabase/functions/door-validate/index.ts
@supabase/migrations/043_door_access.sql
@supabase/migrations/056_security_fixes.sql
@src/components/members/DoorAccessCard.tsx

**Tech stack available:** supabase-js@2.39.3, djwt@v2.8 (Deno JWT)
**Established patterns:**
- SERVICE_ROLE_KEY for Edge Functions (not ANON_KEY)
- Auth lookup via auth_user_id for auth.uid() queries
- Zero information disclosure from public endpoints
- Webhook signature verification with graceful degradation

**Constraining decisions:**
- Phase 5: Team roles (admin, medewerker, coordinator, coach) bypass subscription check for door access
- Phase 5: Door access checks subscription status + end_date
- Phase 6: Edge Functions use SERVICE_ROLE_KEY, zero debug info in responses
- STATE.md: Account claim tokens stored as SHA256 hash pattern (same should apply to QR tokens)

**Issues being addressed:**
- door-token has NO authentication — any caller with member_id can generate tokens
- door-validate compares member.qr_token (plaintext field) but migration 056 introduced hashed storage
- Need to reconcile token storage: either both functions use hash, or clarify which field stores what
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit and fix door-token Edge Function</name>
  <files>supabase/functions/door-token/index.ts</files>
  <action>
  Fix the following security and correctness issues:

  1. **Add authentication**: Require Supabase Auth JWT in Authorization header. Extract user from `supabase.auth.getUser(token)`. Only allow:
     - Admin/medewerker can generate tokens for any member (staff managing door access)
     - Members can generate tokens for themselves only (auth_user_id matches member's auth_user_id)
     Use the same pattern as other authenticated Edge Functions: extract Bearer token, validate with supabase auth, check role.

  2. **Fix qr_token storage**: After generating the JWT token, store the token in the `qr_token` column directly (NOT hashed). The door-validate function needs to compare the full token. Migration 056 added hashing functions but door-token/door-validate use their own JWT-based flow — the qr_token column stores the current active JWT for replay prevention. Confirm this by checking what door-validate reads.

     Actually, the BETTER approach: store a SHA256 hash of the JWT in `qr_token` and update door-validate to also hash the incoming token before comparing. This follows the established pattern from migration 056 and prevents token theft from DB access.

     Implementation:
     - After generating JWT, compute SHA256 hash: `crypto.subtle.digest('SHA-256', new TextEncoder().encode(token))`
     - Store hex hash in `members.qr_token` column
     - Return plaintext JWT to caller (for QR display)

  3. **Input validation**: Validate member_id is a valid UUID format before querying.

  4. **Zero information disclosure**: Don't return specific error messages like "Member not found" or "No active subscription" to unauthenticated callers. Return generic "Access denied" for 403/404 cases. Only return specific errors to authenticated admin/staff users.

  Avoid: Changing the JWT payload structure (member_id, name, iat, exp) — ESP32 firmware depends on this. Avoid changing the response shape (qr_token, expires_in, member_name) — DoorAccessCard depends on this.
  </action>
  <verify>Review the function: auth check present, hash storage, UUID validation, no info disclosure for unauthorized callers</verify>
  <done>door-token requires auth, stores hashed token, validates input, returns generic errors to unauthorized callers</done>
</task>

<task type="auto">
  <name>Task 2: Audit and fix door-validate Edge Function</name>
  <files>supabase/functions/door-validate/index.ts</files>
  <action>
  Fix the following security and correctness issues:

  1. **Fix token comparison to use hash**: Since door-token now stores SHA256 hash, door-validate must hash the incoming JWT before comparing with stored value:
     - After JWT verification succeeds and member_id is extracted
     - Hash the incoming `qrToken` with SHA256
     - Compare hash against `member.qr_token` (which now stores hash)
     - This prevents token theft if DB is compromised

  2. **Add ANON_KEY authentication for ESP32**: The ESP32 calls this endpoint directly. Add the Supabase ANON_KEY as an `apikey` header requirement (standard Supabase Edge Function auth). The ESP32 firmware will need to send this header. This prevents random internet scanners from probing the endpoint.

  3. **Rate limiting consideration**: Add a simple in-memory rate limit per IP or per door_id — max 10 attempts per minute. Use a Map with timestamps. This prevents brute-force scanning. If too complex, at minimum log the attempt count and add a comment for future rate limiting.

  4. **Fix error response consistency**: Ensure all denial reasons match what DoorAccessCard expects: invalid_token, token_expired, token_mismatch, access_disabled, member_inactive, no_active_subscription, member_not_found, system_error. The current `no_subscription` response doesn't match — it should be `no_active_subscription`.

  5. **Verify team role bypass is correct**: Confirm TEAM_ROLES array matches the roles defined in the system: admin, medewerker, coordinator, coach. This is already correct but verify.

  Avoid: Breaking the JSON response shape ({ allowed, reason, member_name }) — ESP32 firmware parses this. Avoid adding auth that would block the ESP32 (it's a device, not a user) — use apikey header instead.
  </action>
  <verify>Review the function: hash comparison, apikey auth, rate limit or comment, consistent denial reasons, team roles correct</verify>
  <done>door-validate uses hash comparison, requires apikey header, denial reasons consistent with frontend, team roles verified</done>
</task>

<task type="auto">
  <name>Task 3: Deploy Edge Functions and set DOOR_JWT_SECRET</name>
  <files>supabase/functions/door-token/index.ts, supabase/functions/door-validate/index.ts</files>
  <action>
  1. Generate a secure DOOR_JWT_SECRET (64-char random hex string):
     `openssl rand -hex 32`

  2. Set the secret in Supabase:
     `npx supabase secrets set DOOR_JWT_SECRET="[generated-key]"`

  3. Deploy both Edge Functions:
     `npx supabase functions deploy door-token`
     `npx supabase functions deploy door-validate`

  4. Verify deployment:
     - `npx supabase functions list` should show both functions
     - Test door-validate with invalid token: `curl -X POST [SUPABASE_URL]/functions/v1/door-validate -H "Content-Type: application/json" -H "apikey: [ANON_KEY]" -d '{"qr":"invalid"}' ` should return `{"allowed":false,"reason":"invalid_token"}`

  Avoid: Displaying the JWT secret or ANON_KEY in output — reference .env file instead.
  </action>
  <verify>npx supabase functions list shows door-token and door-validate as deployed. curl test returns expected JSON response.</verify>
  <done>Both functions deployed, DOOR_JWT_SECRET set, basic smoke test passes</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] door-token requires authentication (Bearer token)
- [ ] door-token stores SHA256 hash of JWT in qr_token column
- [ ] door-validate hashes incoming token before comparison
- [ ] door-validate requires apikey header
- [ ] Denial reason `no_subscription` changed to `no_active_subscription`
- [ ] Both functions deployed successfully
- [ ] DOOR_JWT_SECRET set in Supabase secrets
- [ ] Smoke test: invalid token returns `{"allowed":false,"reason":"invalid_token"}`
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No information disclosure from public endpoints
- Token storage uses SHA256 hashing consistently
- Both Edge Functions deployed and responding
</success_criteria>

<output>
After completion, create `.planning/phases/07-door-access-qr-integration/07-01-SUMMARY.md`
</output>
